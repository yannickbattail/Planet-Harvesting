<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perlin</title>
  <style>
    body {
      background-color: bisque;
    }
    td {
      text-align: center;
      vertical-align: middle;
      border-style: solid;
      border-width: 1px;
    }
  </style>
</head>
<body>

<table id="table"></table>

<script language="javascript">
// Configuration
var ALPHA = 64;
var octaveRange = [3,4,5,6,7];
// [2,3,4,5,6,7,8];

function randGrey(imageData, x, y) {
  let grey = Math.random() * 266;
  setPixelGrey(imageData, x, y, grey, ALPHA);
}

function onEveryPixel(canvas, fct) {
  let ctx = canvas.getContext('2d');
  let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  for (let x = 0; x <canvas.width; x++) {
    for (let y = 0; y < canvas.height; y++) {
      fct(imgData, x, y)
    }
  }
  ctx.putImageData(imgData, 0, 0);
}

function setPixelGrey(imageData, x, y, grey, alpha) {
  setPixel(imageData, x, y, grey, grey, grey, alpha);
}

function setPixel(imageData, x, y, r, g, b, a) {
  let index = (x + y * imageData.width) * 4;
  imageData.data[index+0] = r;
  imageData.data[index+1] = g;
  imageData.data[index+2] = b;
  imageData.data[index+3] = a;
}

function mergeCanvas(canvasSrc, canvasDest) {
  canvasDest.getContext('2d')
    .drawImage(canvasSrc,
        0, 0, canvasSrc.width, canvasSrc.height,
        0, 0, canvasDest.width, canvasDest.height);

}

function renderOctave(i) {
  var octave = document.getElementById('octave'+i);
  var Roctave = document.getElementById('Roctave'+i);
  var render = document.getElementById('render');
  onEveryPixel(octave, randGrey);
  mergeCanvas(octave, Roctave);
  mergeCanvas(Roctave, render);
}

function renderOctaves(octaveRange) {
  octaveRange.forEach(
    i => renderOctave(i)
  );
}

function pow2(x) {
  return Math.pow(2, x);
}

function createHtml(octaveRange) {
  let size = pow2(octaveRange[octaveRange.length-1]);
  let html = '';
  octaveRange.forEach(
    i => {
      html += '<tr>'
      +'<td><canvas id="octave'+i+'" width="'+pow2(i)+'" height="'+pow2(i)+'"></canvas></td>'
      +'<td><canvas id="Roctave'+i+'" width="'+size+'" height="'+size+'"></canvas></td>';
      +'</tr>';
    }
  );
  html += '<tr>'
  + '<td>Final</td>'
  + '<td><canvas id="render" width="'+size+'" height="'+size+'"></canvas></td>'
  + '</tr>';
  let table = document.getElementById("table").innerHTML = html;
}

createHtml(octaveRange);
renderOctaves(octaveRange);

</script>
</body>
</html>
